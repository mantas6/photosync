#!/bin/bash

# Set shell strict mode
set -euo pipefail

pathtoname() {
    udevadm info -p /sys/"$1" | awk -v FS== '/DEVNAME/ {print $2}'
}

stdbuf -oL -- udevadm monitor --udev -s block | while read -r -- _ _ event devpath _; do
    if [ "$event" = add ]; then
        devname=$(pathtoname "$devpath")
        echo "Detected $devname"

        if lsblk -o PATH,TYPE | grep 'part' | grep -q "$devname "; then
            photosync-process "$devname"
        fi
    fi
done
