#!/bin/bash

set -euo pipefail

# A photo in a external device
source="$1"

# Image library root path
output_dir="$2"


echo "Processing $source"

# Get all the meta data from the photo
metadata=$(exiftool -DateTimeOriginal -d "%Y/%m/%d/%H/%M/%S" "$source")

# TODO: add date time validation
datetime=$(echo "$metadata" | grep 'Date/Time Original' | awk '{print $4}')

photo_path=$(echo "$datetime" | cut --delimiter "/" --fields 1,2,3)

# Create a recursive path based on year, month and day
mkdir -pv "$output_dir/$photo_path"

output_basename=$(echo "$datetime" | sed 's/\///g')_$(cksum "$source" | cut -c 1-4)."${source##*.}"
output_filename="$output_dir/$photo_path/$output_basename"

if [ ! -f "$output_filename" ]; then
    cp -nv "$source" "$output_filename"
else
    cmp "$source" "$output_filename" \
        || echo "Files $source $output_filename mismatch" \
        && exit 1
fi


