#!/bin/bash

# Set shell strict mode
set -euo pipefail

# Detected block device that is plugged in
dev_name="$1"

echo "Processing $dev_name"

# Mount the drive as read only
mount_point=$(udisksctl mount -b "$dev_name" -o 'ro' --no-user-interaction \
    | grep 'Mounted' \
    | awk '{print $4}')

unmount() {
    echo 'Preparing to unmount the drive'
    cd
    sleep 5
    udisksctl unmount -b "$dev_name"
}

trap unmount SIGINT

cd "$mount_point"

# Check if marker file exist on the root of the drive
if [ ! -f '.photosync' ]; then
    unmount
    exit 0
fi

tag=$(< .photosync)
[ -z "$tag" ] && echo 'Empty tag value' && exit 1

export PHOTOSYNC_CACHE_TAG="$tag"

cache=$(photosync-cache | tr '\n' '|' | sed 's/|$//')
start_count=$(photosync-cache | wc -l)

# List all jpg files in drive
target_files=$(find . -iname '*.jpg' | grep -Ev "$cache")

echo "$target_files" | xargs -n 1 photosync

end_count=$(photosync-cache | wc -l)
processed_count=$((end_count - start_count))
targeted_count=$(echo "$target_files" | wc -l)

photosync-notify "Processed $processed_count/$targeted_count files" &

unmount

photosync-gallery
