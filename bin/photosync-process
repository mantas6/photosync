#!/bin/bash

# Set shell strict mode
set -euo pipefail

output_dir="$HOME/Pictures/Gallery/Originals"
mkdir -pv "$output_dir"

# Detected block device that is plugged in
dev_name="$1"

# Mount the drive as read only
mount_point=$(udisksctl mount -b "$dev_name" -o 'ro' --no-user-interaction \
    | grep 'Mounted' \
    | awk '{print $4}')

unmount() {
    echo 'Preparing to unmount the drive'
    cd
    sleep 5
    udisksctl unmount -b "$dev_name"
}

trap unmount SIGINT

cd "$mount_point"

# Check if marker file exist on the root of the drive
if [ ! -f '.photosync' ]; then
    unmount
    exit 0
fi

photosync-notify "Processing drive $dev_name" &

# List all jpg files in drive
find . -iname '*.jpg' -exec photosync {} "$output_dir" \;

photosync-notify "Finished processing" &
echo "Finish processing drive"

unmount
